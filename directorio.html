<!doctype html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Â¡Blog!Â¡Blog! RSS</title>
        <link rel="stylesheet" href="estilos.css" />
    </head>
    <body>
        <!-- header externo -->
        <div id="header-placeholder"></div>

        <script>
            // Cargar header desde un archivo externo
            fetch("header.html")
                .then((response) => response.text())
                .then((data) => {
                    document.getElementById("header-placeholder").innerHTML =
                        data;
                })
                .catch((err) =>
                    console.error("Error al cargar header.html:", err),
                );
        </script>

        <main>
            <div>
                <p id="contador"></p>
                <p id="fecha"></p>
            </div>

            <div class="filtros">
                <select id="filtroPais">
                    <option value="">ðŸŒŽ Todos los paÃ­ses</option>
                </select>
                <select id="filtroCategoria">
                    <option value="">ðŸ“š Todas las categorÃ­as</option>
                </select>
            </div>
            <div id="contenedor"></div>
        </main>

        <!-- Footer externo -->
        <div id="footer-placeholder"></div>

        <script>
            // Cargar footer desde un archivo externo
            fetch("footer.html")
                .then((response) => response.text())
                .then((data) => {
                    document.getElementById("footer-placeholder").innerHTML =
                        data;
                })
                .catch((err) =>
                    console.error("Error al cargar footer.html:", err),
                );
        </script>

        <script>
            const contenedor = document.getElementById("contenedor");
            const filtroPais = document.getElementById("filtroPais");
            const filtroCategoria = document.getElementById("filtroCategoria");
            let blogs = [];

            // ðŸŸ¡ NUEVO: mapa de banderas
            const banderas = {
                Argentina: "ðŸ‡¦ðŸ‡·",
                Bolivia: "ðŸ‡§ðŸ‡´",
                Chile: "ðŸ‡¨ðŸ‡±",
                Colombia: "ðŸ‡¨ðŸ‡´",
                Cuba: "ðŸ‡¨ðŸ‡º",
                Ecuador: "ðŸ‡ªðŸ‡¨",
                EspaÃ±a: "ðŸ‡ªðŸ‡¸",
                MÃ©xico: "ðŸ‡²ðŸ‡½",
                Paraguay: "ðŸ‡µðŸ‡¾",
                PerÃº: "ðŸ‡µðŸ‡ª",
                Uruguay: "ðŸ‡ºðŸ‡¾",
                Venezuela: "ðŸ‡»ðŸ‡ª",
            };

            // ðŸŸ¡ NUEVO: mapa de emojis por categorÃ­a
            const categoriasEmoji = {
                "AIRE LIBRE": "ðŸƒ",
                "ARTE Y DISEÃ‘O": "ðŸŽ¨",
                "CIENCIA Y HUMANIDADES": "ðŸ§ª",
                "COMIDA Y BEBIDA": "ðŸ½ï¸",
                "ENTRETENIMIENTO Y CULTURA": "ðŸ“º",
                FOTOGRAFÃA: "ðŸ“¸",
                NEWSLETTER: "ðŸ—žï¸",
                LITERARIO: "ðŸ“š",
                "MANUALIDADES / HOBBIES": "âœ‚ï¸",
                PODCAST: "ðŸŽ™ï¸",
                TECNOLOGÃA: "ðŸ’»",
                "SOCIEDAD Y ECONOMÃA": "ðŸ’¸",
                VIAJES: "âœˆï¸",
                "VIDA DIARIA": "ðŸ ",
            };

            fetch("blogs.json")
                .then((res) => {
                    if (!res.ok)
                        throw new Error("No se pudo cargar blogs.json");
                    const ultimaActualizacion =
                        res.headers.get("Last-Modified");
                    return res
                        .json()
                        .then((data) => ({ data, ultimaActualizacion }));
                })
                .then(({ data, ultimaActualizacion }) => {
                    blogs = data;

                    poblarFiltros();
                    mostrarBlogs(blogs);

                    const totalBlogs = blogs.length;
                    const contador = document.getElementById("contador");
                    if (contador)
                        contador.textContent = `ðŸŽ‰ Â¡Llegamos al blog NÂ° ${totalBlogs}!`;

                    const fechaElemento = document.getElementById("fecha");
                    if (fechaElemento) {
                        if (ultimaActualizacion) {
                            const fecha = new Date(ultimaActualizacion);
                            const opciones = {
                                day: "numeric",
                                month: "long",
                                year: "numeric",
                            };
                            const fechaFormateada = fecha
                                .toLocaleDateString("es-ES", opciones)
                                .toUpperCase();
                            fechaElemento.textContent = `Actualizado: ${fechaFormateada}`;
                        } else {
                            fechaElemento.textContent = `Ãšltima actualizaciÃ³n: (sin datos)`;
                        }
                    }
                })
                .catch((err) => {
                    const contenedor = document.getElementById("contenedor");
                    if (contenedor)
                        contenedor.innerHTML =
                            "<p>Error al cargar los blogs ðŸ˜¢</p><p>" +
                            err.message +
                            "</p>";
                });

            function poblarFiltros() {
                const paises = [
                    ...new Set(blogs.map((b) => b.PaÃ­s).filter(Boolean)),
                ].sort();
                const categorias = [
                    ...new Set(
                        blogs
                            .flatMap((b) =>
                                b.CategorÃ­a
                                    ? b.CategorÃ­a.split(",").map((c) =>
                                          c.trim(),
                                      )
                                    : [],
                            )
                            .filter(Boolean),
                    ),
                ].sort();

                paises.forEach((p) => {
                    const opt = document.createElement("option");
                    const bandera = banderas[p] || ""; // ðŸŸ¡ NUEVO
                    opt.value = p;
                    opt.textContent = `${bandera} ${p}`; // ðŸŸ¡ NUEVO
                    filtroPais.appendChild(opt);
                });

                // al poblar filtros
                categorias.forEach((c) => {
                    const opt = document.createElement("option");
                    const emoji = categoriasEmoji[c.trim().toUpperCase()] || ""; // ðŸŸ¢ AJUSTADO
                    opt.value = c;
                    opt.textContent = `${emoji} ${c}`;
                    filtroCategoria.appendChild(opt);
                });

                filtroPais.addEventListener("change", filtrar);
                filtroCategoria.addEventListener("change", filtrar);
            }

            function filtrar() {
                const paisSel = filtroPais.value;
                const catSel = filtroCategoria.value;
                const filtrados = blogs.filter((b) => {
                    const matchPais = paisSel ? b.PaÃ­s === paisSel : true;
                    const matchCat = catSel
                        ? b.CategorÃ­a && b.CategorÃ­a.includes(catSel)
                        : true;
                    return matchPais && matchCat;
                });
                mostrarBlogs(filtrados);
            }

            function mostrarBlogs(lista) {
                contenedor.innerHTML = "";
                if (!lista.length) {
                    contenedor.innerHTML =
                        "<p>No hay blogs con esos filtros ðŸ˜¢</p>";
                    return;
                }

                lista.forEach((b) => {
                    const item = document.createElement("div");
                    item.className = "item";
                    if (b.Aliado !== undefined) item.classList.add("aliado");

                    let url = b.Url || "";
                    if (url && !url.startsWith("http")) {
                        url = "https://" + url;
                    }

                    const dominio = url
                        .replace(/^https?:\/\//, "")
                        .split("/")[0];
                    const favicon = `https://www.google.com/s2/favicons?domain=${dominio}`;

                    const etiquetaAliado =
                        b.Aliado !== undefined
                            ? '<img src="https://blogsencastellano.wordpress.com/wp-content/uploads/2025/08/frog-pixel-recortada.gif" alt="Aliado" />'
                            : "";

                    const bandera = banderas[b.PaÃ­s] || ""; // ðŸŸ¡ NUEVO

                    // al mostrar blogs
                    const categoriasConEmoji = b.CategorÃ­a
                        ? b.CategorÃ­a.split(",")
                              .map(
                                  (c) =>
                                      `${categoriasEmoji[c.trim().toUpperCase()] || ""} ${c.trim()}`,
                              )
                              .join(", ")
                        : "-";

                    item.innerHTML = `
            <div class="blog">
              <img src="${favicon}" alt="favicon" style="width:16px;height:16px;vertical-align:middle;margin-right:6px;">
              <a href="${b.Url}" target="_blank">${b.Nombre}</a>${etiquetaAliado}
            </div>
            <p class="descripcion">${b.DescripciÃ³n || ""}</p>
            <p><strong>CategorÃ­a:</strong> ${categoriasConEmoji}<br>
            <strong>PaÃ­s:</strong> ${bandera} ${b.PaÃ­s || "-"}</p>
            <a href="${b.Feed}" target="_blank">ðŸ”— RSS</a>
          `;
                    contenedor.appendChild(item);
                });
            }
        </script>
    </body>
</html>
